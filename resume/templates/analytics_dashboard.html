{% extends 'base.html' %}
{% block title %}Analytics Dashboard{% endblock %}
{% block content %}
<section class="section" data-aos="fade-up">
  <h2 class="mb-4">Analytics Dashboard</h2>
  <div class="row g-4">
    <div class="col-md-3 col-6">
      <div class="skill-item h-100 text-center">
        <h3 class="mb-1">Total Users</h3>
        <p class="display-6 mb-0">{{ total_users }}</p>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="skill-item h-100 text-center">
        <h3 class="mb-1">Verified</h3>
        <p class="display-6 mb-0">{{ verified_users }}</p>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="skill-item h-100 text-center">
        <h3 class="mb-1">Unverified</h3>
        <p class="display-6 mb-0">{{ unverified_users }}</p>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="skill-item h-100 text-center">
        <h3 class="mb-1">Contacts</h3>
        <p class="display-6 mb-0">{{ total_contacts }}</p>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="skill-item h-100 text-center">
        <h3 class="mb-1">Resumes Emailed</h3>
        <p class="display-6 mb-0">{{ total_resume_emails }}</p>
      </div>
    </div>
  </div>
</section>

<section class="section mt-4" data-aos="fade-up" data-aos-delay="100">
  <h3 class="mb-3">Visualizations</h3>
  <div class="row g-4">
    <div class="col-md-4">
      <h5 class="text-center mb-2">Verified vs Unverified Users</h5>
      <canvas id="verifiedPie"></canvas>
    </div>
    <div class="col-md-4">
      <h5 class="text-center mb-2">Resume Downloads vs Emails</h5>
      <canvas id="resumeBar"></canvas>
    </div>
    <div class="col-md-4">
      <h5 class="text-center mb-2">Downloads/Emailed per User</h5>
      <canvas id="userLine"></canvas>
    </div>
    <div class="col-md-12 mt-4">
      <h5 class="text-center mb-2">User Signups per Day</h5>
      <canvas id="signupsLine"></canvas>
    </div>
  </div>
</section>

<section class="section mt-4" data-aos="fade-up" data-aos-delay="150">
  <h3 class="mb-3">User Analytics</h3>
  <div class="table-responsive">
    <table class="table table-sm align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Username</th>
          <th>Email</th>
          <th>Verified</th>
          <th>Downloads</th>
          <th>Emailed</th>
          <th>Joined</th>
          <th>Last Login</th>
        </tr>
      </thead>
      <tbody>
        {% for u in user_rows %}
        <tr>
          <td>{{ u.username }}</td>
          <td>{{ u.email }}</td>
          <td>
            {% if u.is_verified %}
              <span class="badge bg-success">Yes</span>
            {% else %}
              <span class="badge bg-secondary">No</span>
            {% endif %}
          </td>
          <td>{{ u.downloads }}</td>
          <td>{{ u.emails }}</td>
          <td>{{ u.date_joined|date:"Y-m-d" }}</td>
          <td>{% if u.last_login %}{{ u.last_login|date:"Y-m-d H:i" }}{% else %}-{% endif %}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center text-muted">No users found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const verifiedData = {{ chart_verified|safe }};
    const resumeData = {{ chart_resume|safe }};
    const userRows = {{ user_rows|safe }};
    const signupsLabels = {{ chart_signups_labels|safe }};
    const signupsValues = {{ chart_signups_values|safe }};

    // Pie chart: verified vs unverified
    const verifiedCtx = document.getElementById('verifiedPie');
    if (verifiedCtx) {
      new Chart(verifiedCtx, {
        type: 'pie',
        data: {
          labels: ['Verified', 'Unverified'],
          datasets: [{
            data: verifiedData,
            backgroundColor: ['#22c55e', '#9ca3af'],
          }]
        },
        options: {
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }

    // Bar chart: total downloads vs total emails
    const resumeCtx = document.getElementById('resumeBar');
    if (resumeCtx) {
      new Chart(resumeCtx, {
        type: 'bar',
        data: {
          labels: ['Downloads', 'Emailed'],
          datasets: [{
            label: 'Count',
            data: resumeData,
            backgroundColor: ['#3b82f6', '#f97316'],
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Line chart: per-user downloads/emails
    const userCtx = document.getElementById('userLine');
    if (userCtx && Array.isArray(userRows)) {
      const labels = userRows.map(u => u.username);
      const downloads = userRows.map(u => u.downloads);
      const emails = userRows.map(u => u.emails);

      new Chart(userCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Downloads',
              data: downloads,
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.2)',
              tension: 0.3,
            },
            {
              label: 'Emailed',
              data: emails,
              borderColor: '#f97316',
              backgroundColor: 'rgba(249, 115, 22, 0.2)',
              tension: 0.3,
            }
          ]
        },
        options: {
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Line chart: user signups per day
    const signupsCtx = document.getElementById('signupsLine');
    if (signupsCtx && Array.isArray(signupsLabels)) {
      new Chart(signupsCtx, {
        type: 'line',
        data: {
          labels: signupsLabels,
          datasets: [{
            label: 'New Users',
            data: signupsValues,
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37, 99, 235, 0.15)',
            tension: 0.3,
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true, ticks: { precision: 0 } }
          }
        }
      });
    }
  });
</script>
{% endblock %}
